{% extends "base.html" %}
{% block title %}–¢–∞–ª–∞–ø–∫–µ—Ä ‚Äî –ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<section class="hero">
  <div class="container hero-inner">
    <h1>–ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤</h1>
    <p>–° –ø–æ–º–æ—â—å—é "–¢–∞–ª–∞–ø–∫–µ—Ä" –≤—ã –ª–µ–≥–∫–æ —É–∑–Ω–∞–µ—Ç–µ –≤—Å—ë –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –∏ –ø–æ–¥–∞—á–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>
    <a class="btn orange" href="#chat-section">–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ</a>
  </div>
</section>

<!-- –ß–∞—Ç-–±–æ—Ç -->
<section id="chat-section" class="section container">
  <h2>–ß–∞—Ç —Å –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º</h2>
  <div id="chat-box" class="chat-box">
    <div class="messages" id="messages">
      <div class="message bot">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ø–æ–º–æ–≥—É –≤–∞–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ–º. –ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å üëá</div>
    </div>
    <form id="chat-form" class="chat-form">
      <input type="text" id="user-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..." required autocomplete="off">
      <button type="button" id="voice-btn" class="voice-btn" aria-label="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">
  <i class="fas fa-microphone"></i>
</button>
      <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  // === –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ ===
  const userInput = document.getElementById('user-input');
  const voiceBtn = document.getElementById('voice-btn');
  const chatForm = document.getElementById('chat-form');
  const messages = document.getElementById('messages');

  // –Ø–∑—ã–∫
  const lang = "{{ session.get('lang', 'ru') }}";
  const speechLangMap = { 'ru': 'ru-RU', 'kk': 'kk-KZ', 'en': 'en-US' };
  const recognitionLang = speechLangMap[lang] || 'ru-RU';

  let recognition;
  let isRecording = false;

  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = recognitionLang;
    recognition.interimResults = true;
    recognition.continuous = false;

    recognition.onresult = (event) => {
      let transcript = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        transcript += event.results[i][0].transcript;
      }
      userInput.value = transcript;
    };

    recognition.onerror = (event) => {
      console.error('Speech error:', event.error);
      voiceBtn.classList.remove('recording');
      isRecording = false;

      if (event.error === 'not-allowed') {
        alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.');
      }
    };

    recognition.onend = () => {
      voiceBtn.classList.remove('recording');
      isRecording = false;
    };

    voiceBtn.addEventListener('click', () => {
      if (isRecording) {
        recognition.stop();
        return;
      }

      try {
        recognition.start();
        voiceBtn.classList.add('recording');
        isRecording = true;
      } catch (err) {
        console.error(err);
        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.');
      }
    });
  } else {
    voiceBtn.style.display = 'none';
  }

  // === –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è ===
  function addMessage(text, type = "bot") {
    const div = document.createElement("div");
    div.className = "message " + type;
    div.textContent = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  // === –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø ===
  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const text = userInput.value.trim();
    if (!text) return;

    // –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage(text, "user");
    userInput.value = "";

    // –ü–ª–∞—à–∫–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç..."
    const typing = document.createElement("div");
    typing.className = "message bot typing";
    typing.textContent = "–ü–∏—à—É –æ—Ç–≤–µ—Ç...";
    messages.appendChild(typing);
    messages.scrollTop = messages.scrollHeight;

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });

      const data = await res.json();

      typing.remove(); // —É–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä

      addMessage(data.reply, "bot");

    } catch (err) {
      typing.remove();
      addMessage("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", "bot");
    }
  });
</script>

{% endblock %}
