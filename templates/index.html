{% extends "base.html" %}
{% block title %}–¢–∞–ª–∞–ø–∫–µ—Ä ‚Äî –ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block content %}
<section class="hero">
  <div class="container hero-inner">
    <h1>–ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤</h1>
    <p>–° –ø–æ–º–æ—â—å—é "–¢–∞–ª–∞–ø–∫–µ—Ä" –≤—ã –ª–µ–≥–∫–æ —É–∑–Ω–∞–µ—Ç–µ –≤—Å—ë –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –∏ –ø–æ–¥–∞—á–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>
    <a class="btn orange" href="#chat-section">–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ</a>
  </div>
</section>

<!-- –ß–∞—Ç-–±–æ—Ç -->
<section id="chat-section" class="section container">
  <h2>–ß–∞—Ç —Å –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º</h2>
  <div id="chat-box" class="chat-box">
    <div class="messages" id="messages">
      <div class="message bot">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ø–æ–º–æ–≥—É –≤–∞–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ–º. –ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å üëá</div>
    </div>
    <form id="chat-form" class="chat-form">
      <input type="text" id="user-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..." required autocomplete="off">
      <button type="button" id="voice-btn" class="voice-btn" aria-label="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">
  <i class="fas fa-microphone"></i>
</button>
      <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  // === –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ ===
  const userInput = document.getElementById('user-input');
  const voiceBtn = document.getElementById('voice-btn');
  const chatForm = document.getElementById('chat-form');
  const messages = document.getElementById('messages');

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –∏–∑ —Å–µ—Å—Å–∏–∏
  const lang = "{{ session.get('lang', 'ru') }}";
  const speechLangMap = {
    'ru': 'ru-RU',
    'kk': 'kk-KZ',
    'en': 'en-US'
  };
  const recognitionLang = speechLangMap[lang] || 'ru-RU';

  let recognition;
  let isRecording = false;

  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = recognitionLang;
    recognition.interimResults = true;
    recognition.continuous = false;

    recognition.onresult = (event) => {
      let transcript = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        transcript += event.results[i][0].transcript;
      }
      userInput.value = transcript;
    };

    recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      voiceBtn.classList.remove('recording');
      isRecording = false;
      if (event.error === 'not-allowed') {
        alert('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
      }
    };

    recognition.onend = () => {
      voiceBtn.classList.remove('recording');
      isRecording = false;
    };

    voiceBtn.addEventListener('click', () => {
      if (isRecording) {
        recognition.stop();
        return;
      }

      try {
        recognition.start();
        voiceBtn.classList.add('recording');
        isRecording = true;
      } catch (err) {
        console.error(err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
      }
    });
  } else {
    voiceBtn.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç
  }

  // === –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ===
  chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const text = userInput.value.trim();
    if (!text) return;

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userMsg = document.createElement('div');
    userMsg.className = 'message user';
    userMsg.textContent = text;
    messages.appendChild(userMsg);

    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
    userInput.value = '';
    messages.scrollTop = messages.scrollHeight;

    // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞
    setTimeout(() => {
      const botMsg = document.createElement('div');
      botMsg.className = 'message bot';
      botMsg.textContent = `–í—ã —Å–∫–∞–∑–∞–ª–∏: "${text}". –Ø –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤–∞—à –∑–∞–ø—Ä–æ—Å...`;
      messages.appendChild(botMsg);
      messages.scrollTop = messages.scrollHeight;
    }, 800);
  });
</script>
{% endblock %}