{% extends "base.html" %}
{% block title %}{{ t('Талапкер') }} — {{ t('Главная') }}{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Добавляем анимированный градиентный фон и частицы (как в оригинальном сайте) -->
<div class="bg-gradient"></div>
<div class="particles" id="particles"></div>

<section class="hero" style="height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center; margin: 0; padding: 0; position: relative; overflow: hidden;">
  <div class="hero-inner" style="background-image: url('/static/images/zhubanov.png'); background-size: cover; background-position: center; color: #fff; height: 100%; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); position: relative;">
    <!-- Полупрозрачный градиентный оверлей (улучшенный, как в оригинале) -->
    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(15,23,36,0.7), rgba(43,140,255,0.4)); z-index: 1;"></div>
    
    <!-- Красивый текст над фото (как в оригинальном: с градиентом, анимацией float и shine) -->
    <h1 class="hero-title" style="position: relative; z-index: 2; font-size: 4.5rem; font-weight: 900; margin-bottom: 2rem; background: linear-gradient(45deg, #fff, #e0e0e0, #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.2; animation: titleFloat 3s ease-in-out infinite, textShine 3s linear infinite; background-size: 200% auto;">{{ t('ИИ-консультант для абитуриентов') }}</h1>
    
    <!-- Текст с пульсацией в овале (как hero-badge в оригинальном сайте) -->
    <div class="hero-badge" style="position: relative; z-index: 2;">{{ t('С помощью "Талапкер" вы легко узнаете всё о поступлении и подаче документов') }}</div>
    
    <!-- Улучшенная кнопка "Узнать больше" (с градиентом, hover-эффектом подъёма, тенью и плавным переходом, как в оригинальном .btn-primary) -->
    <a class="btn orange btn-primary" href="#chat-section" style="position: relative; z-index: 2;"> {{ t('Узнать больше') }}</a>
  </div>
</section>

<section id="chat-section" class="section container">
  <h2>{{ t('Чат с консультантом') }}</h2>

  <!-- НОВЫЙ ДВУХКОЛОНОЧНЫЙ ЧАТ (без изменений) -->
  <div class="chat-layout">
    <div class="chat-sidebar" id="chat-sidebar">
      <div class="sidebar-header">
        <i class="fas fa-bolt"></i> {{t('Частые вопросы')}}
        <button class="sidebar-close" id="sidebar-close">×</button>
      </div>
      <div class="sidebar-content" id="quick-questions"></div>
    </div>

    <div class="chat-main">
      <div id="chat-box" class="chat-box">
        <div class="messages" id="messages">
          <div class="message bot">
            <div class="bubble" style="background:linear-gradient(135deg,var(--secondary-color),var(--primary-color)); color:#fff; border-radius:18px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,0.15);">
              {{ t('Здравствуйте! Я — Талапкер, ИИ-помощник по приёму абитуриентов в Университет имени К. Жубанова') }}<br><br>
              {{ t('Задайте любой вопрос или выберите один из частых') }}
            </div>
          </div>
        </div>
        <button class="sidebar-toggle" id="sidebar-toggle">
          <i class="fas fa-chevron-right"></i>
        </button>
        <div id="typing-indicator" style="display:none;" class="message bot">
          <div class="bubble typing"><span></span><span></span><span></span></div>
        </div>

        <form id="chat-form" class="chat-form">
          <textarea id="user-input" placeholder="{{ t('Сұрағыңызды жазыңыз...') }}" rows="1" autocomplete="off"></textarea>
          <button type="button" id="voice-btn" class="voice-btn" aria-label="{{ t('Голосовой ввод') }}">
            <i class="fas fa-microphone"></i>
          </button>
          <button type="submit"><i class="fas fa-paper-plane"></i></button>
        </form>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<style>
  /* Анимированный градиентный фон (как в оригинальном сайте) */
  .bg-gradient {
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: -2;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    animation: gradientShift 15s ease infinite;
    background-size: 200% 200%;
  }
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* Частицы (particles) для эффекта (как в оригинальном, но теперь синие) */
  .particles {
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: -1;
  }
  .particle {
    position: absolute;
    width: 4px;
    height: 4px;
    background: rgba(102, 126, 234, 0.6); /* Синий цвет (#667eea с прозрачностью) */
    border-radius: 50%;
    animation: particleFloat 20s infinite linear;
  }
  @keyframes particleFloat {
    0% { transform: translateY(100vh) translateX(0); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateY(-100vh) translateX(100px); opacity: 0; }
  }

  /* Пульсация для hero-badge (как в оригинальном сайте) */
  .hero-badge {
    display: inline-block;
    padding: 1rem 2.5rem;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 50px;
    margin-bottom: 3rem;
    border: 1px solid rgba(255, 255, 255, 0.3);
    font-weight: 700;
    font-size: 1.4rem;
    opacity: 0.95;
    line-height: 1.8;
    max-width: 900px;
    text-align: center;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
    50% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); }
  }

  /* Улучшенные стили для кнопки (как .btn-primary в оригинальном: градиент, hover с подъёмом, тенью) */
  .btn-primary {
    padding: 1.2rem 3rem;
    border-radius: 50px;
    font-weight: 700;
    font-size: 1.1rem;
    text-decoration: none;
    transition: all 0.4s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(45deg, #ff7e5f, #feb47b); /* Оранжевый градиент для вашего стиля "orange" */
    color: #fff;
    border: 2px solid transparent;
    box-shadow: 0 10px 30px rgba(255, 126, 95, 0.4); /* Тень в оранжевых тонах */
  }
  .btn-primary:hover {
    transform: translateY(-5px); /* Подъём вверх на hover */
    box-shadow: 0 15px 40px rgba(255, 126, 95, 0.6); /* Усиленная тень */
  }

  /* Анимации для текста (как в оригинальном: float и shine) */
  @keyframes titleFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  @keyframes textShine {
    to { background-position: 200% center; }
  }

  /* Адаптив для мобильных (как в оригинальном, базово) */
  @media (max-width: 768px) {
    .hero-title {
      font-size: 2.8rem !important;
    }
    .hero-badge {
      font-size: 1.1rem;
      padding: 0.8rem 1.5rem;
    }
    .btn-primary {
      width: 100%; /* Полная ширина на мобильных */
      max-width: 280px;
      text-align: center;
    }
  }
  @media (max-width: 480px) {
    .hero-title {
      font-size: 2.2rem !important;
    }
    .hero-badge {
      font-size: 1rem;
      padding: 0.8rem 1.5rem;
    }
  }
</style>

<script>
// Создание частиц (как в оригинальном сайте)
function createParticles() {
  const container = document.getElementById('particles');
  for (let i = 0; i < 50; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.style.left = Math.random() * 100 + '%';
    particle.style.animationDelay = Math.random() * 20 + 's';
    particle.style.animationDuration = (15 + Math.random() * 10) + 's';
    container.appendChild(particle);
  }
}
createParticles();

// Остальной ваш скрипт без изменений
const lang = "{{ session.get('lang', 'ru') }}";
const userInput = document.getElementById('user-input');
const messages = document.getElementById('messages');
const sidebar = document.getElementById('chat-sidebar');
const toggleBtn = document.getElementById('sidebar-toggle');
const closeBtn = document.getElementById('sidebar-close');
const typingIndicator = document.getElementById('typing-indicator');
const quickBox = document.getElementById('quick-questions');

async function loadQuickQuestions() {
  try {
    const res = await fetch('/api/chat/options');
    const data = await res.json();
    quickBox.innerHTML = "";

    data.options.forEach(q => {
      const btn = document.createElement('button');
      btn.className = 'quick-btn';

      if (q.includes('Назад') || q.includes('Артқа') || q.includes('Back') || q.includes('назад')) {
        btn.classList.add('back');
        btn.innerHTML = q;
      } else {
        btn.textContent = q;
      }

      btn.onclick = () => sendMessage(q);
      quickBox.appendChild(btn);
    });

    const ask = document.createElement('div');
    ask.className = 'ask-own';
    ask.innerHTML = `
      <p style="opacity:0.7; margin-bottom:6px;">${t("Не нашли нужный вопрос?")}</p>
      <button class="quick-btn special">${t("Задать свой вопрос")}</button>
    `;
    ask.querySelector("button").onclick = () => userInput.focus();
    quickBox.appendChild(ask);

  } catch (err) {
    console.error("Ошибка загрузки опций:", err);
  }
}

loadQuickQuestions();

const predefined = [
  { keys: ["сроки", "қашан"], ru: "СРОКИ ПРИЁМА 2025–2026:\n• Бакалавриат: 1 июня – 25 июля\n• Магистратура: 1 июня – 15 июля\n• Докторантура: 1 июня – 10 июля" },
  { keys: ["грант"], ru: "Да, есть государственные гранты. Результаты — на enbek.kz" },
  { keys: ["стоимость", "ақысы"], ru: "Бакалавриат: 850–1 500 тыс. ₸/год\nМагистратура: от 1 100 тыс. ₸" },
  { keys: ["общежитие", "жатақхана"], ru: "Да, есть. Стоимость: 15–25 тыс. ₸/мес." }
];

function getPredefinedAnswer(text) {
  const lower = text.toLowerCase();
  for (const item of predefined) {
    if (item.keys.some(k => lower.includes(k))) return item.ru;
  }
  return null;
}

function addMessage(text, type = "bot") {
  const div = document.createElement('div');
  div.className = `message ${type}`;
  if (type === "bot") {
    div.innerHTML = marked.parse(text.replace(/\n/g, '  \n'));
  } else {
    const formattedText = text.replace(/\n/g, '<br>');
    div.innerHTML = formattedText;
  }
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

async function sendMessage(text) {
  if (!text.trim()) return;

  addMessage(text, "user");
  userInput.value = "";

  const predefined = getPredefinedAnswer(text);
  if (predefined) {
    setTimeout(() => {
      addMessage(predefined, "bot");
      loadQuickQuestions();
    }, 600);
    return;
  }

  typingIndicator.style.display = "flex";

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text })
    });
    const data = await res.json();

    typingIndicator.style.display = "none";
    addMessage(data.reply, 'bot');

    loadQuickQuestions();

  } catch (err) {
    typingIndicator.style.display = "none";
    addMessage("Ошибка соединения", 'bot');
  }
}

document.getElementById('chat-form').addEventListener('submit', e => {
  e.preventDefault();
  const text = userInput.value.trim();
  if (text) {
    sendMessage(text);
    userInput.value = '';
    userInput.style.height = 'auto';
  }
});

userInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    const text = userInput.value.trim();
    if (text) {
      sendMessage(text);
      userInput.value = '';
      userInput.style.height = 'auto';
    }
  }
  this.style.height = 'auto';
  this.style.height = (this.scrollHeight) + 'px';
});

let recognition, isRecording = false;
if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = lang === 'kk' ? 'kk-KZ' : lang === 'en' ? 'en-US' : 'ru-RU';
  recognition.interimResults = true;

  recognition.onresult = e => {
    userInput.value = Array.from(e.results).map(r => r[0].transcript).join('');
  };
  recognition.onend = () => {
    document.getElementById('voice-btn').classList.remove('recording');
    isRecording = false;
  };

  document.getElementById('voice-btn').addEventListener('click', () => {
    if (isRecording) {
      recognition.stop();
    } else {
      recognition.start();
      document.getElementById('voice-btn').classList.add('recording');
      isRecording = true;
    }
  });
} else {
  document.getElementById('voice-btn').style.display = 'none';
}

async function loadChatHistory() {
  try {
    const res = await fetch('/api/chat/history');
    if (!res.ok) return;
    const history = await res.json();
    if (history.length > 0) messages.innerHTML = '';
    history.forEach(entry => {
      addMessage(entry.message, 'user');
      addMessage(entry.response, 'bot');
    });
  } catch (err) {
    console.error("Не удалось загрузить историю");
  }
}
document.addEventListener('DOMContentLoaded', loadChatHistory);

function openSidebar() { sidebar.classList.add('active'); }
function closeSidebar() { sidebar.classList.remove('active'); }

toggleBtn?.addEventListener('click', e => { e.stopPropagation(); openSidebar(); });
closeBtn?.addEventListener('click', e => { e.stopPropagation(); closeSidebar(); });

document.querySelector('.chat-layout')?.addEventListener('click', e => {
  if (!e.target.closest('.chat-sidebar') && sidebar.classList.contains('active')) {
    closeSidebar();
  }
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && sidebar.classList.contains('active')) closeSidebar();
});

</script>
{% endblock %}