{% extends "base.html" %}
{% block title %}{{ t('Талапкер') }} — {{ t('Главная') }}{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<section class="hero">
  <div class="container hero-inner">
    <h1>{{ t('ИИ-консультант для абитуриентов') }}</h1>
    <p>{{ t('С помощью "Талапкер" вы легко узнаете всё о поступлении и подаче документов') }}</p>
    <a class="btn orange" href="#chat-section">{{ t('Узнать больше') }}</a>
  </div>
</section>

<section id="chat-section" class="section container">
  <h2>{{ t('Чат с консультантом') }}</h2>

  <!-- НОВЫЙ ДВУХКОЛОНОЧНЫЙ ЧАТ -->
  <div class="chat-layout">
    
    <!-- ЛЕВАЯ ПАНЕЛЬ — быстрые вопросы -->
<div class="chat-sidebar" id="chat-sidebar"> <!-- убран класс active -->
     <!-- ВОТ ЭТА СТРОКА ДОЛЖНА БЫТЬ ИМЕННО ТАКОЙ -->
<div class="sidebar-header">
  <i class="fas fa-bolt"></i> {{t('Частые вопросы')}}
  <button class="sidebar-close" id="sidebar-close">×</button>  <!-- ← ЭТО ОБЯЗАТЕЛЬНО! -->
</div>
      <div class="sidebar-content" id="quick-questions"></div>
    </div>

    <!-- ПРАВАЯ ПАНЕЛЬ — сам чат -->
    <div class="chat-main">
      <div id="chat-box" class="chat-box">
        <div class="messages" id="messages">
          <!-- Приветственное сообщение -->
          <div class="message bot">
            <div class="bubble" style="background:linear-gradient(135deg,var(--secondary-color),var(--primary-color)); color:#fff; border-radius:18px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,0.15);">
              {{ t('Здравствуйте! Я — Талапкер, ИИ-помощник по приёму абитуриентов в Университет имени К. Жубанова') }}<br><br>
              {{ t('Задайте любой вопрос или выберите один из частых') }}
            </div>
          </div>
        </div>
          <!-- КРАСИВАЯ СТРЕЛКА — ОДНА, СНАРУЖИ, С УНИКАЛЬНЫМ ID -->
  <button class="sidebar-toggle" id="sidebar-toggle">
    <i class="fas fa-chevron-right"></i>
  </button>
        <!-- Индикатор "печатает" -->
        <div id="typing-indicator" style="display:none;" class="message bot">
          <div class="bubble typing"><span></span><span></span><span></span></div>
        </div>

        <form id="chat-form" class="chat-form">
          <input type="text" id="user-input" placeholder="{{ t('Сұрағыңызды жазыңыз...') }}" autocomplete="off">
          <button type="button" id="voice-btn" class="voice-btn" aria-label="{{ t('Голосовой ввод') }}">
            <i class="fas fa-microphone"></i>
          </button>
          <button type="submit"><i class="fas fa-paper-plane"></i></button>
        </form>
      </div>
    </div>

  
  </div>
</section>
{% endblock %}
{% block scripts %}

<script>
// === ВСЁ В ОДНОМ СКРИПТЕ — РАБОТАЕТ НА 100% ===

const lang = "{{ session.get('lang', 'ru') }}";
const userInput = document.getElementById('user-input');
const messages = document.getElementById('messages');
const sidebar = document.getElementById('chat-sidebar');
const toggleBtn = document.getElementById('sidebar-toggle');
const closeBtn = document.getElementById('sidebar-close');
const typingIndicator = document.getElementById('typing-indicator');
const quickBox = document.getElementById('quick-questions');  // ← добавил

// === 1. Загрузка быстрых вопросов (ОБНОВЛЕНА) ===
async function loadQuickQuestions() {
  try {
    const res = await fetch('/api/chat/options');
    const data = await res.json();
    quickBox.innerHTML = "";  // очищаем

    data.options.forEach(q => {
      const btn = document.createElement('button');
      btn.className = 'quick-btn';

      // Специально выделяем кнопку "Назад"
      if (q.includes('Назад') || q.includes('Артқа') || q.includes('Back') || q.includes('назад')) {
        btn.classList.add('back');
        btn.innerHTML = q;  // с иконкой, если будет
      } else {
        btn.textContent = q;
      }

      btn.onclick = () => sendMessage(q);
      quickBox.appendChild(btn);
    });

    // Кнопка "Задать свой вопрос" — оставляем как было
    const ask = document.createElement('div');
    ask.className = 'ask-own';
    ask.innerHTML = `
      <p style="opacity:0.7; margin-bottom:6px;">${t("Не нашли нужный вопрос?")}</p>
      <button class="quick-btn special">${t("Задать свой вопрос")}</button>
    `;
    ask.querySelector("button").onclick = () => userInput.focus();
    quickBox.appendChild(ask);

  } catch (err) {
    console.error("Ошибка загрузки опций:", err);
  }
}

// Первый вызов — при загрузке страницы
loadQuickQuestions();

// === 2. Точные ответы (оставил как было) ===
const predefined = [
  { keys: ["сроки", "қашан"], ru: "СРОКИ ПРИЁМА 2025–2026:\n• Бакалавриат: 1 июня – 25 июля\n• Магистратура: 1 июня – 15 июля\n• Докторантура: 1 июня – 10 июля" },
  { keys: ["грант"], ru: "Да, есть государственные гранты. Результаты — на enbek.kz" },
  { keys: ["стоимость", "ақысы"], ru: "Бакалавриат: 850–1 500 тыс. ₸/год\nМагистратура: от 1 100 тыс. ₸" },
  { keys: ["общежитие", "жатақхана"], ru: "Да, есть. Стоимость: 15–25 тыс. ₸/мес." }
];

function getPredefinedAnswer(text) {
  const lower = text.toLowerCase();
  for (const item of predefined) {
    if (item.keys.some(k => lower.includes(k))) return item.ru;
  }
  return null;
}

// === 3. Добавление сообщения ===
function addMessage(text, type = "bot") {
  const div = document.createElement('div');
  div.className = `message ${type}`;
  if (type === "bot") {
    div.innerHTML = marked.parse(text.replace(/\n/g, '  \n'));
  } else {
    div.textContent = text;
  }
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

// === 4. Отправка сообщения (ГЛАВНОЕ ИСПРАВЛЕНИЕ) ===
async function sendMessage(text) {
  if (!text.trim()) return;

  addMessage(text, "user");
  userInput.value = "";

  const predefined = getPredefinedAnswer(text);
  if (predefined) {
    setTimeout(() => {
      addMessage(predefined, "bot");
      loadQuickQuestions();  // ← обновляем кнопки и после предопределённого ответа
    }, 600);
    return;
  }

  typingIndicator.style.display = "flex";

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text })
    });
    const data = await res.json();

    typingIndicator.style.display = "none";
    addMessage(data.reply, 'bot');

    // КЛЮЧЕВАЯ СТРОКА: обновляем кнопки после КАЖДОГО ответа от сервера
    loadQuickQuestions();

  } catch (err) {
    typingIndicator.style.display = "none";
    addMessage("Ошибка соединения", 'bot');
  }
}

// === 5. Форма ===
document.getElementById('chat-form').addEventListener('submit', e => {
  e.preventDefault();
  const text = userInput.value.trim();
  if (text) sendMessage(text);
});

// === 6. Голосовой ввод (без изменений) ===
let recognition, isRecording = false;
if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = lang === 'kk' ? 'kk-KZ' : lang === 'en' ? 'en-US' : 'ru-RU';
  recognition.interimResults = true;

  recognition.onresult = e => {
    userInput.value = Array.from(e.results).map(r => r[0].transcript).join('');
  };
  recognition.onend = () => {
    document.getElementById('voice-btn').classList.remove('recording');
    isRecording = false;
  };

  document.getElementById('voice-btn').addEventListener('click', () => {
    if (isRecording) {
      recognition.stop();
    } else {
      recognition.start();
      document.getElementById('voice-btn').classList.add('recording');
      isRecording = true;
    }
  });
} else {
  document.getElementById('voice-btn').style.display = 'none';
}

// === 7. Загрузка истории (без изменений) ===
async function loadChatHistory() {
  try {
    const res = await fetch('/api/chat/history');
    if (!res.ok) return;
    const history = await res.json();
    if (history.length > 0) messages.innerHTML = '';
    history.forEach(entry => {
      addMessage(entry.message, 'user');
      addMessage(entry.response, 'bot');
    });
  } catch (err) {
    console.error("Не удалось загрузить историю");
  }
}
document.addEventListener('DOMContentLoaded', loadChatHistory);

// === 8. Управление сайдбаром (без изменений) ===
function openSidebar() { sidebar.classList.add('active'); }
function closeSidebar() { sidebar.classList.remove('active'); }

toggleBtn?.addEventListener('click', e => { e.stopPropagation(); openSidebar(); });
closeBtn?.addEventListener('click', e => { e.stopPropagation(); closeSidebar(); });

document.querySelector('.chat-layout')?.addEventListener('click', e => {
  if (!e.target.closest('.chat-sidebar') && sidebar.classList.contains('active')) {
    closeSidebar();
  }
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && sidebar.classList.contains('active')) closeSidebar();
});

</script>

{% endblock %}